<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width,initial-scale=1,viewport-fit=cover">
<title>The List</title>
<link rel="manifest" href="manifest.webmanifest">
<link rel="apple-touch-icon" href="icons/icon-192.png">
<meta name="theme-color" content="#0f1115">
<style>
/* Compact-first + dense presets + keyboard-safe bottom UI */
:root{
  --header-h: 52px;
  --search-h: 56px;
  --radius: 12px;
  --radius-sm: 9px;
  --gap: 10px;
  --pad: 12px;
  --shadow: 0 6px 14px rgba(0,0,0,.22);
  --accent: #59d1ff;
  --kb: 0px; /* dynamic keyboard lift */
  --font-scale: 1; /* adjustable in Settings */
}

html,body{height:100%}
body{
  margin:0;
  font-family: system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji","Segoe UI Emoji";
  font-size: calc(14px*var(--font-scale));
  line-height:1.25;
  background:#0f1115; color:#e8eaed;
  -webkit-tap-highlight-color:transparent;
}
body.light{background:#f7f7f9;color:#111318}
button,input,select,textarea{font-size:inherit;color:inherit}

/* Header */
.header{
  position:fixed; inset:0 0 auto 0; height:var(--header-h);
  display:flex; align-items:center; justify-content:space-between;
  padding:0 var(--pad); z-index:10;
  background:rgba(10,12,16,.78); backdrop-filter:blur(8px);
  border-bottom:1px solid rgba(255,255,255,.06)
}
body.light .header{background:rgba(255,255,255,.9);border-bottom:1px solid rgba(0,0,0,.06)}
.header .title{font-weight:700; letter-spacing:.2px}
.header .actions{display:flex; gap:6px}
.icon-btn{
  min-width:36px; height:36px; border-radius:10px;
  border:1px solid rgba(255,255,255,.08);
  background:rgba(255,255,255,.04); color:inherit;
  display:inline-flex; align-items:center; justify-content:center; padding:0 8px
}
body.light .icon-btn{background:rgba(0,0,0,.04);border-color:rgba(0,0,0,.08)}
.icon-btn:active{transform:translateY(1px) scale(.98)}
.icon-btn .only{display:inline-block; font-size:1rem}

/* Main + list */
.main{padding-top:calc(var(--header-h) + 6px); padding-bottom:calc(var(--search-h) + 72px); max-width:800px; margin:0 auto}
.list{display:flex; flex-direction:column; gap:8px; padding:6px var(--pad) 80px}

/* Cards */
.card{
  border-radius:var(--radius);
  background:linear-gradient(180deg, rgba(255,255,255,.04), rgba(255,255,255,.02));
  border:1px solid rgba(255,255,255,.06); padding:8px 10px 6px
}
body.light .card{background:#fff; border-color:rgba(0,0,0,.06)}
.card-row{display:flex; align-items:center; justify-content:space-between; gap:6px}
.names{font-weight:600; overflow:hidden; text-overflow:ellipsis; white-space:nowrap}
.sep{opacity:.5; padding:0 4px}
.row-icons{display:inline-flex; gap:4px}

/* Meta row: Sell left, Bought right, one pencil edits both */
.meta{
  display:flex; gap:10px; flex-wrap:wrap; align-items:center; margin-top:2px
}
.meta .sell, .meta .buy{
  display:inline-flex; align-items:center; gap:6px; opacity:.9
}
.meta .sell{order:1;font-size:.9rem}
.meta .buy{order:2;font-size:.45rem;opacity:.75} /* half of .9rem */
.meta .one-edit{margin-left:auto}

/* Buttons small */
.small-btn{
  min-width:30px; height:30px; border-radius:9px;
  border:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.05); color:inherit
}
body.light .small-btn{background:rgba(0,0,0,.04); border-color:rgba(0,0,0,.08)}

/* Dropdown */
.dropdown{margin-top:8px; border-radius:var(--radius-sm); background:rgba(255,255,255,.04); border:1px solid rgba(255,255,255,.06); padding:6px}
body.light .dropdown{background:rgba(0,0,0,.03); border-color:rgba(0,0,0,.08)}
.dropdown .bar{display:flex; align-items:center; gap:6px; flex-wrap:wrap}

/* Toggle (icons only) */
.toggle-type{
  border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.06);
  color:inherit; border-radius:9px; padding:6px 8px;
  display:inline-flex; align-items:center; gap:6px
}
body.light .toggle-type{background:rgba(0,0,0,.05); border-color:rgba(0,0,0,.08)}
.toggle-type .only{font-size:1rem}

/* Preset row (compact) */
.preset-row{display:flex; gap:6px; overflow-x:auto; -webkit-overflow-scrolling:touch; scrollbar-width:thin; padding:2px 0; flex:1}
.preset{
  min-width:68px; max-width:92px; flex:0 0 auto;
  border-radius:9px; padding:6px 7px;
  background:#131722; border:1px solid rgba(255,255,255,.08); position:relative; color:inherit
}
body.light .preset{background:#f4f6f9; border-color:rgba(0,0,0,.08)}
.preset .top{font-weight:600; font-size:.8rem; line-height:1; color:inherit}
.preset .bottom{font-size:.72rem; opacity:.9; margin-top:2px; line-height:1; color:inherit}
.preset.add{min-width:48px; display:inline-flex; align-items:center; justify-content:center; background:transparent; border-style:dashed}
.preset .edit{position:absolute; top:2px; right:2px; background:transparent; border:none; color:inherit; opacity:.7; font-size:.8rem}

/* Mini converter row within dropdown */
.conv{
  display:flex; align-items:center; gap:6px; flex-wrap:nowrap
}
.conv .input{
  display:flex; flex-direction:column; gap:4px; min-width:90px
}
.conv input{
  border-radius:9px; border:1px solid rgba(255,255,255,.1);
  background:rgba(255,255,255,.05); color:inherit; padding:6px 8px; width:100%
}
body.light .conv input{background:rgba(0,0,0,.04); border-color:rgba(0,0,0,.1)}
.mini-total{
  margin-left:auto; font-weight:800; display:flex; align-items:center; gap:8px
}
.mini-total .val{font-size:1.05rem}
.mini-total .val .dec{font-size:.6em; opacity:.9}
.mini-actions{display:inline-flex; gap:6px}
.mini-actions .add{opacity:.6}
.mini-actions .add.enabled{opacity:1}

/* Search bar (always bottom; moves with keyboard) */
.search-wrap{position:fixed; left:0; right:0; height:var(--search-h); padding:6px var(--pad); display:flex; align-items:center; z-index:11; bottom: calc(env(safe-area-inset-bottom) + var(--kb));}
.search-inner{max-width:800px; margin:0 auto; display:flex; gap:6px; width:100%}
.search{flex:1; display:flex; gap:6px; align-items:center; background:rgba(255,255,255,.06); border:1px solid rgba(255,255,255,.1); border-radius:10px; padding:6px 8px}
body.light .search{background:rgba(0,0,0,.04); border-color:rgba(0,0,0,.08)}
.search input{flex:1; border:none; outline:none; background:transparent; color:inherit}

/* FAB (also lifts) */
.fab{position:fixed; right:16px; bottom: calc(16px + env(safe-area-inset-bottom) + var(--kb)); height:52px; width:52px; border-radius:50%; background:linear-gradient(180deg, var(--accent), #2ab8ff); color:#001018; border:none; box-shadow:var(--shadow); font-weight:800; z-index:12}

/* Modals + forms */
.modal{position:fixed; inset:0; display:none; align-items:flex-end; justify-content:center; z-index:50}
.modal.open{display:flex}
.backdrop{position:absolute; inset:0; background:rgba(0,0,0,.45); backdrop-filter:blur(4px)}
.sheet{position:relative; width:100%; max-width:820px; border-top-left-radius:16px; border-top-right-radius:16px; background:#0f131c; border:1px solid rgba(255,255,255,.08); transform:translateY(100%); animation:slideUp .22s ease forwards}
@keyframes slideUp{to{transform:translateY(0)}}
body.light .sheet{background:#fff; border-color:rgba(0,0,0,.08)}
.sheet .handle{width:42px; height:4px; border-radius:3px; background:rgba(255,255,255,.25); margin:8px auto 2px}
.sheet .header-row{display:flex; align-items:center; justify-content:space-between; padding:6px 12px}
.sheet .content{padding:6px 12px 12px; max-height:65vh; overflow:auto}
.form-grid{display:grid; grid-template-columns:1fr; gap:8px}
.input{display:flex; flex-direction:column; gap:4px}
.input label{font-size:.8rem; opacity:.8}
.input input,.input textarea,.input select{border-radius:9px; border:1px solid rgba(255,255,255,.1); background:rgba(255,255,255,.05); color:inherit; padding:8px 10px}
body.light .input input, body.light .input textarea, body.light .input select{background:rgba(0,0,0,.04); border-color:rgba(0,0,0,.1)}
.btn{border-radius:10px; border:none; padding:8px 12px; font-weight:700}
.btn.primary{background:var(--accent); color:#001018}
.btn.alt{background:rgba(255,255,255,.08); color:inherit; border:1px solid rgba(255,255,255,.12)}
.btn.danger{background:#ff5c5c; color:#fff}
.divider{height:1px; background:rgba(255,255,255,.08); margin:6px 0}
.small-muted{font-size:.75rem; opacity:.75}

/* Calculator modal: sticky total at top, ‚ÄúC‚Äù clears all, Save ‚Üí bills */
.calc-head{position:sticky; top:0; background:inherit; padding:6px 0; display:flex; align-items:center; gap:8px; border-bottom:1px solid rgba(255,255,255,.1)}
.calc-title{font-weight:800}
.calc-title .clearC{margin-left:6px; border:1px solid rgba(255,255,255,.15); border-radius:6px; padding:2px 6px; background:transparent; color:inherit}
.calc-total{margin-left:auto; font-weight:800}
.calc-total .dec{font-size:.6em; opacity:.9}

/* Bill history list */
.bill-list .row{display:flex; align-items:center; justify-content:space-between; padding:8px 0; border-bottom:1px solid rgba(255,255,255,.08)}
</style>
</head>
<body class="dark">
  <header class="header">
    <div class="title">The List</div>
    <div class="actions">
      <button class="icon-btn" id="billBtn" title="Bill history"><span class="only">üßæ</span></button>
      <button class="icon-btn" id="settingsBtn" title="Settings"><span class="only">‚öôÔ∏è</span></button>
      <button class="icon-btn" id="themeBtn" title="Theme"><span class="only">üåô</span></button>
      <button class="icon-btn" id="recordsHeaderBtn" title="Recent"><span class="only">üïò</span></button>
      <button class="icon-btn" id="calcBtn" title="Calculator"><span class="only">üßÆ</span></button>
    </div>
  </header>

  <main class="main">
    <div class="list" id="list"></div>
    <div id="emptyState" class="small-muted" style="text-align:center; padding:20px 0; display:none">No items yet. Tap + to add your first item.</div>
  </main>

  <button id="fab" class="fab" title="Add">Ôºã</button>

  <!-- Search bar (always bottom, lifts with keyboard) -->
  <div id="searchWrap" class="search-wrap" aria-label="Search bar">
    <div class="search-inner">
      <div class="search" style="flex:1">
        <span>üîé</span>
        <input id="searchInput" type="text" placeholder="Search any part of name‚Ä¶" autocapitalize="none" autocomplete="off" spellcheck="false">
        <button id="clearSearchBtn" class="icon-btn" style="min-width:30px;height:30px">‚úï</button>
      </div>
    </div>
  </div>

  <!-- Item Modal (one pencil edits both prices + names) -->
  <div class="modal" id="itemModal" role="dialog" aria-modal="true">
    <div class="backdrop" data-close="itemModal"></div>
    <div class="sheet">
      <div class="handle"></div>
      <div class="header-row">
        <div id="itemModalTitle" class="small-muted">Add item</div>
        <button class="small-btn" data-close="itemModal">‚úï</button>
      </div>
      <div class="content">
        <form id="itemForm" novalidate>
          <div class="form-grid">
            <div class="input" id="name1Wrap"><label for="name1">Name 1</label><input id="name1" required maxlength="80"></div>
            <div class="input" id="name2Wrap"><label for="name2">Name 2</label><input id="name2" required maxlength="80"></div>
            <div class="input" id="name3Wrap"><label for="name3">Name 3</label><input id="name3" required maxlength="80"></div>
            <div class="input" id="spriceWrap"><label for="sprice">Selling ‚Çπ/kg</label><input id="sprice" type="number" step="0.01" min="0" inputmode="decimal"></div>
            <div class="input" id="bpriceWrap"><label for="bprice">Bought ‚Çπ/kg</label><input id="bprice" type="number" step="0.01" min="0" inputmode="decimal"></div>
          </div>
          <div class="divider"></div>
          <div class="small-muted">Default presets added on create.</div>
          <div style="display:flex; gap:6px; justify-content:flex-end; margin-top:8px">
            <button type="button" class="btn alt" data-close="itemModal">Cancel</button>
            <button type="submit" class="btn primary">Save</button>
            <button type="button" class="btn danger" id="deleteItemBtn" style="display:none">Delete</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Preset Modal (with optional override fields) -->
  <div class="modal" id="presetModal" role="dialog" aria-modal="true">
    <div class="backdrop" data-close="presetModal"></div>
    <div class="sheet">
      <div class="handle"></div>
      <div class="header-row">
        <div id="presetModalTitle" class="small-muted">Edit preset</div>
        <button class="small-btn" data-close="presetModal">‚úï</button>
      </div>
      <div class="content">
        <form id="presetForm" novalidate>
          <div class="input" id="presetValWrap"><label id="presetValLabel" for="presetVal">Value</label><input id="presetVal" type="number" step="0.01" min="0" inputmode="decimal"></div>
          <div class="input" id="overrideWrap"><label id="overrideLabel" for="overrideVal">Override (optional)</label><input id="overrideVal" type="number" step="0.01" min="0" inputmode="decimal" placeholder="Leave empty for auto"></div>
          <div style="display:flex; gap:6px; justify-content:flex-end; margin-top:8px">
            <button type="button" class="btn alt" data-close="presetModal">Cancel</button>
            <button type="submit" class="btn primary">Save</button>
          </div>
        </form>
      </div>
    </div>
  </div>

  <!-- Notes Modal -->
  <div class="modal" id="notesModal" role="dialog" aria-modal="true">
    <div class="backdrop" data-close="notesModal"></div>
    <div class="sheet">
      <div class="handle"></div>
      <div class="header-row">
        <div class="small-muted">Notes</div>
        <button class="small-btn" data-close="notesModal">‚úï</button>
      </div>
      <div class="content">
        <div class="input"><label for="notesText">Notes</label><textarea id="notesText" rows="8" placeholder="Write notes‚Ä¶"></textarea></div>
        <div style="display:flex; gap:6px; justify-content:flex-end; margin-top:8px">
          <button type="button" class="btn alt" data-close="notesModal">Cancel</button>
          <button type="button" class="btn primary" id="saveNotesBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Recent Modal -->
  <div class="modal" id="recordsModal" role="dialog" aria-modal="true">
    <div class="backdrop" data-close="recordsModal"></div>
    <div class="sheet">
      <div class="handle"></div>
      <div class="header-row">
        <div class="small-muted">Recent</div>
        <button class="small-btn" data-close="recordsModal">‚úï</button>
      </div>
      <div class="content">
        <div id="recordsList"></div>
        <div style="display:flex; align-items:center; justify-content:space-between; margin-top:6px">
          <div class="small-muted">Tap to search or open item</div>
          <button class="btn alt" id="clearRecordsBtn">Clear all</button>
        </div>
      </div>
    </div>
  </div>

  <!-- Calculator Modal (results + total + Save + ‚ÄúC‚Äù) -->
  <div class="modal" id="calcModal" role="dialog" aria-modal="true">
    <div class="backdrop" data-close="calcModal"></div>
    <div class="sheet">
      <div class="handle"></div>

      <div class="content">
        <div class="calc-head">
          <div class="calc-title">Calculator <button class="clearC" id="clearBillBtn" title="Clear bill">C</button></div>
          <div style="margin-left:8px"><button class="btn alt" id="saveBillBtn" title="Save receipt">Save bill</button></div>
          <div class="calc-total" id="mainTotalTop">‚Çπ0<span class="dec">.00</span></div>
          <button class="small-btn" data-close="calcModal" title="Close" style="margin-left:8px">‚úï</button>
        </div>

        <div id="calcList"></div>
      </div>
    </div>
  </div>

  <!-- Bill History Modal -->
  <div class="modal" id="billModal" role="dialog" aria-modal="true">
    <div class="backdrop" data-close="billModal"></div>
    <div class="sheet">
      <div class="handle"></div>
      <div class="header-row">
        <div class="small-muted">Bill history</div>
        <button class="small-btn" data-close="billModal">‚úï</button>
      </div>
      <div class="content bill-list" id="billList"></div>
    </div>
  </div>

  <!-- Settings Modal -->
  <div class="modal" id="settingsModal" role="dialog" aria-modal="true">
    <div class="backdrop" data-close="settingsModal"></div>
    <div class="sheet">
      <div class="handle"></div>
      <div class="header-row">
        <div class="small-muted">Settings</div>
        <button class="small-btn" data-close="settingsModal">‚úï</button>
      </div>
      <div class="content">
        <div class="input">
          <label for="fontScale">Font scale</label>
          <input id="fontScale" type="range" min="0.85" max="1.15" step="0.01">
        </div>
        <div class="input">
          <label for="accentPick">Accent color</label>
          <input id="accentPick" type="color">
        </div>
        <div class="input">
          <label for="lineCap">Max calculator lines</label>
          <input id="lineCap" type="number" min="10" step="10">
        </div>
        <div style="display:flex; gap:6px; justify-content:flex-end; margin-top:8px">
          <button type="button" class="btn alt" data-close="settingsModal">Close</button>
          <button type="button" class="btn primary" id="saveSettingsBtn">Save</button>
        </div>
      </div>
    </div>
  </div>

<script>
/* ===== IndexedDB K/V ===== */
const idb = (() => {
  const DB = 'the-list-db', STORE = 'kv';
  let dbp = null;
  function open(){ if(dbp) return dbp;
    dbp = new Promise((res,rej)=>{ const r = indexedDB.open(DB,1);
      r.onupgradeneeded = e => { const db=e.target.result; if(!db.objectStoreNames.contains(STORE)) db.createObjectStore(STORE); };
      r.onsuccess = () => res(r.result); r.onerror = () => rej(r.error);
    }); return dbp;
  }
  async function get(key){ const db=await open(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readonly'); const st=tx.objectStore(STORE); const rq=st.get(key); rq.onsuccess=()=>res(rq.result); rq.onerror=()=>rej(r.error); });}
  async function set(key,val){ const db=await open(); return new Promise((res,rej)=>{ const tx=db.transaction(STORE,'readwrite'); const st=tx.objectStore(STORE); const rq=st.put(val,key); rq.onsuccess=()=>res(); rq.onerror=()=>rej(r.error); });}
  return {get,set};
})();

/* ===== State + defaults ===== */
const defaultWeightPresets = [{val:"50",label:"50g"},{val:"100",label:"100g"},{val:"500",label:"500g"},{val:"1000",label:"1kg"}];
const defaultPricePresets  = [{val:"10",label:"‚Çπ10"},{val:"30",label:"‚Çπ30"},{val:"50",label:"‚Çπ50"}];

const state = {
  items: [],
  recentSearches: [],
  recentItems: [],
  ui: {
    theme:'dark',
    activeDropdownItemId:null,
    dropdownType:'weight',
    mini: { itemId:null, amount:0, gramsInput:'', priceInput:'' }
  },
  calc: { lines: [], total: 0 },
  bills: [], // {id, ts, lines:[{itemName, grams, price, lineTotal}], total}
  settings: { fontScale:1, accent:'#59d1ff', lineCap:50 }
};

/* ===== Elements ===== */
const listEl = document.getElementById('list');
const emptyEl = document.getElementById('emptyState');
const themeBtn = document.getElementById('themeBtn');
const settingsBtn = document.getElementById('settingsBtn');
const recordsHeaderBtn = document.getElementById('recordsHeaderBtn');
const billBtn = document.getElementById('billBtn');
const calcBtn = document.getElementById('calcBtn');
const fab = document.getElementById('fab');
const searchInput = document.getElementById('searchInput');
const clearSearchBtn = document.getElementById('clearSearchBtn');

/* Modals + forms */
const itemModal = document.getElementById('itemModal');
const itemForm = document.getElementById('itemForm');
const itemModalTitle = document.getElementById('itemModalTitle');
const name1 = document.getElementById('name1');
const name2 = document.getElementById('name2');
const name3 = document.getElementById('name3');
const bprice = document.getElementById('bprice');
const sprice = document.getElementById('sprice');
const deleteItemBtn = document.getElementById('deleteItemBtn');

const presetModal = document.getElementById('presetModal');
const presetForm = document.getElementById('presetForm');
const presetVal = document.getElementById('presetVal');
const presetValLabel = document.getElementById('presetValLabel');
const overrideWrap = document.getElementById('overrideWrap');
const overrideLabel = document.getElementById('overrideLabel');
const overrideVal = document.getElementById('overrideVal');

const recordsModal = document.getElementById('recordsModal');
const recordsList = document.getElementById('recordsList');
const clearRecordsBtn = document.getElementById('clearRecordsBtn');

const calcModal = document.getElementById('calcModal');
const calcList = document.getElementById('calcList');
const mainTotalTop = document.getElementById('mainTotalTop');
const clearBillBtn = document.getElementById('clearBillBtn');
const saveBillBtn = document.getElementById('saveBillBtn');

const billModal = document.getElementById('billModal');
const billList = document.getElementById('billList');

const settingsModal = document.getElementById('settingsModal');
const fontScale = document.getElementById('fontScale');
const accentPick = document.getElementById('accentPick');
const lineCap = document.getElementById('lineCap');

/* ===== Helpers ===== */
const byId = id => state.items.find(i=>i.id===id);
const genId = () => Math.random().toString(36).slice(2)+Date.now().toString(36);
const clamp = (n,min,max)=>Math.max(min,Math.min(max,n));
const escapeHtml = s => String(s||'').replace(/[&<>"']/g, c=>({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[c]));

/* Rounded-rupee rule: floor unless fractional >= 0.9 then ceil */
function rupeeRound(x){
  const f = x - Math.floor(x);
  return (f >= 0.9) ? Math.ceil(x) : Math.floor(x);
}
/* format main/mini with small decimals */
function fmtMain(n){
  const v = (Number(n)||0).toFixed(2);
  const [a,b] = v.split('.');
  return `‚Çπ${a}<span class="dec">.${b}</span>`;
}

/* ===== Persistence ===== */
async function loadAll(){
  const [items,recent,recentItems,theme,settings,calc,bills] = await Promise.all([
    idb.get('items'), idb.get('recent'), idb.get('recentItems'),
    idb.get('theme'), idb.get('settings'), idb.get('calc'), idb.get('bills')
  ]);
  state.items = Array.isArray(items)? items : [];
  state.recentSearches = Array.isArray(recent)? recent : [];
  state.recentItems = Array.isArray(recentItems)? recentItems : [];
  if(theme==='light'||theme==='dark') state.ui.theme = theme;
  if(settings) state.settings = Object.assign(state.settings, settings);
  if(calc && Array.isArray(calc.lines)) { state.calc = calc; }
  if(Array.isArray(bills)) state.bills = bills.slice(0,20);
  applyTheme(); applySettings(); renderList(); renderRecords(); renderCalc(); renderBills();
}
const saveItems = () => idb.set('items', state.items);
const saveRecent = () => idb.set('recent', state.recentSearches);
const saveRecentItems = () => idb.set('recentItems', state.recentItems);
const saveTheme = () => idb.set('theme', state.ui.theme);
const saveSettings = () => idb.set('settings', state.settings);
const saveCalc = () => idb.set('calc', state.calc);
const saveBills = () => idb.set('bills', state.bills.slice(0,20));

/* ===== Theme + Settings ===== */
function applyTheme(){
  document.body.classList.toggle('light', state.ui.theme==='light');
  document.body.classList.toggle('dark', state.ui.theme==='dark');
  themeBtn.querySelector('.only').textContent = state.ui.theme==='light' ? '‚òÄÔ∏è' : 'üåô';
}
themeBtn.addEventListener('click', ()=>{ state.ui.theme = state.ui.theme==='dark'?'light':'dark'; applyTheme(); saveTheme(); });

function applySettings(){
  document.documentElement.style.setProperty('--font-scale', state.settings.fontScale);
  document.documentElement.style.setProperty('--accent', state.settings.accent);
}
settingsBtn.addEventListener('click', ()=>{
  fontScale.value = state.settings.fontScale;
  accentPick.value = state.settings.accent;
  lineCap.value = state.settings.lineCap;
  openModal('settingsModal');
});
document.getElementById('saveSettingsBtn').addEventListener('click', ()=>{
  state.settings.fontScale = +fontScale.value || 1;
  state.settings.accent = accentPick.value || '#59d1ff';
  state.settings.lineCap = clamp(parseInt(lineCap.value,10)||50, 10, 500);
  applySettings(); saveSettings(); closeModal('settingsModal');
});

/* ===== Keyboard lift (VisualViewport + VirtualKeyboard) ===== */
(function setupKeyboardLift(){
  function setKb(px){ document.documentElement.style.setProperty('--kb', Math.max(0, px)+'px'); }
  if ('virtualKeyboard' in navigator) {
    try {
      navigator.virtualKeyboard.overlaysContent = true;
      navigator.virtualKeyboard.addEventListener('geometrychange', (e)=> setKb(e.target.boundingRect.height||0) );
    } catch(e){}
  }
  if (window.visualViewport){
    const vv = window.visualViewport;
    const onVv = ()=> setKb( Math.max(0, (window.innerHeight - (vv.height||window.innerHeight))) );
    vv.addEventListener('resize', onVv);
    vv.addEventListener('scroll', onVv);
  }
})();

/* ===== Modals ===== */
function openModal(id){ const el=document.getElementById(id); if(el) el.classList.add('open'); }
function closeModal(id){ const el=document.getElementById(id); if(el) el.classList.remove('open'); }
document.addEventListener('click', e=>{ const c=e.target.getAttribute('data-close'); if(c) closeModal(c); if(e.target.classList.contains('backdrop')){ const id=e.target.getAttribute('data-close'); if(id) closeModal(id);} });
document.addEventListener('keydown', e=>{ if(e.key==='Escape'){ const open=[...document.querySelectorAll('.modal.open')]; if(open.length) open.at(-1).classList.remove('open'); }});

/* ===== Search (contains match) ===== */
function getQuery(){ return (searchInput.value||'').trim().toLowerCase(); }
searchInput.addEventListener('input', ()=>{
  const q=getQuery(); if(q){ state.recentSearches=[q, ...state.recentSearches.filter(x=>x!==q)].slice(0,15); saveRecent(); }
  renderList();
});
clearSearchBtn.addEventListener('click', ()=>{ searchInput.value=''; renderList(); searchInput.focus(); });

recordsHeaderBtn.addEventListener('click', ()=> openModal('recordsModal'));

/* ===== Add item ===== */
fab.addEventListener('click', startAddItem);
function startAddItem(){
  state.ui.editingItemId = null; itemModalTitle.textContent='Add item'; deleteItemBtn.style.display='none';
  name1.value=''; name2.value=''; name3.value=''; bprice.value=''; sprice.value='';
  openModal('itemModal'); setTimeout(()=>name1.focus(),50);
}
function startEditItem(id){
  const it=byId(id); if(!it) return;
  state.ui.editingItemId=id; itemModalTitle.textContent='Edit item'; deleteItemBtn.style.display='inline-block';
  name1.value=it.name1; name2.value=it.name2; name3.value=it.name3; bprice.value=it.bprice; sprice.value=it.sprice;
  openModal('itemModal');
}
function validateItem(){ return name1.value.trim()&&name2.value.trim()&&name3.value.trim() && parseFloat(bprice.value)>=0 && parseFloat(sprice.value)>=0; }
itemForm.addEventListener('submit', async (e)=>{
  e.preventDefault(); if(!validateItem()) return alert('Please fill all fields correctly.');
  const payload = { name1:name1.value.trim(), name2:name2.value.trim(), name3:name3.value.trim(), bprice:+(+bprice.value||0).toFixed(2), sprice:+(+sprice.value||0).toFixed(2) };
  if(!state.ui.editingItemId){
    state.items.unshift({ id:genId(), ...payload, presets:{ weight:JSON.parse(JSON.stringify(defaultWeightPresets)), price:JSON.parse(JSON.stringify(defaultPricePresets)) }, notes:'' });
  }else{
    const it=byId(state.ui.editingItemId); Object.assign(it, payload);
  }
  await saveItems(); closeModal('itemModal'); renderList();
});
deleteItemBtn.addEventListener('click', async ()=>{
  if(!state.ui.editingItemId) return; const it=byId(state.ui.editingItemId);
  if(it && confirm(`Delete "${it.name1} / ${it.name2} / ${it.name3}"?`)){
    state.items = state.items.filter(x=>x.id!==it.id);
    if(state.ui.activeDropdownItemId===it.id) state.ui.activeDropdownItemId=null;
    await saveItems(); closeModal('itemModal'); renderList();
  }
});

/* ===== Notes ===== */
let editingNotesItemId=null;
function startEditNotes(id){ const it=byId(id); if(!it) return; editingNotesItemId=id; document.getElementById('notesText').value=it.notes||''; openModal('notesModal');}
document.getElementById('saveNotesBtn').addEventListener('click', async ()=>{ const it=byId(editingNotesItemId); if(it){ it.notes = document.getElementById('notesText').value; await saveItems(); } closeModal('notesModal'); });

/* ===== Preset edit with override ===== */
function startEditPreset({itemId,type,presetIndex}){
  const it=byId(itemId); if(!it) return;
  state.ui.editingPreset={itemId,type,presetIndex};
  document.getElementById('presetModalTitle').textContent = (presetIndex===-1?'Add ':'Edit ') + (type==='weight'?'weight':'price') + ' preset';
  const p = presetIndex===-1? null : it.presets[type][presetIndex];
  presetVal.value = p?.val ?? '';
  if(type==='weight'){ presetValLabel.textContent='Grams (g)'; overrideLabel.textContent='Override price ‚Çπ (optional)'; }
  else { presetValLabel.textContent='Price (‚Çπ)'; overrideLabel.textContent='Override grams (optional)'; }
  overrideVal.value = (type==='weight'? p?.overridePrice : p?.overrideGrams) ?? '';
  openModal('presetModal'); setTimeout(()=>presetVal.focus(),50);
}
presetForm.addEventListener('submit', async (e)=>{
  e.preventDefault(); const ep=state.ui.editingPreset; if(!ep) return;
  const v=parseFloat(presetVal.value); if(isNaN(v)||v<0) return alert('Enter a valid number ‚â• 0.');
  const ov = parseFloat(overrideVal.value);
  const it=byId(ep.itemId); if(!it) return;
  if(ep.type==='weight'){
    const obj={ val:String(v), label: v===1000?'1kg':`${v}g` };
    if(!isNaN(ov)) obj.overridePrice = +ov;
    if(ep.presetIndex===-1) it.presets.weight.push(obj); else it.presets.weight[ep.presetIndex]=obj;
  } else {
    const obj={ val:String(v), label:`‚Çπ${v}` };
    if(!isNaN(ov)) obj.overrideGrams = +ov;
    if(ep.presetIndex===-1) it.presets.price.push(obj); else it.presets.price[ep.presetIndex]=obj;
  }
  await saveItems(); closeModal('presetModal'); state.ui.editingPreset=null; renderList();
});

/* ===== Records (recent searches + items MRU) ===== */
function bumpRecentItem(id){
  state.recentItems = [id, ...state.recentItems.filter(x=>x!==id)].slice(0,15);
  saveRecentItems();
}
function renderRecords(){
  recordsList.innerHTML='';
  const s = state.recentSearches.map(q=>({type:'search',label:q}));
  const its = state.recentItems.map(id=>{ const it=byId(id); return it? {type:'item', id, label:`${it.name1} / ${it.name2} / ${it.name3}`} : null; }).filter(Boolean);
  const rows = [...its, ...s];
  if(!rows.length){ recordsList.innerHTML='<div class="small-muted" style="text-align:center;padding:10px 0">No recent</div>'; return; }
  rows.forEach(r=>{
    const row=document.createElement('div');
    row.className='row'; row.style.cssText='display:flex;justify-content:space-between;align-items:center;padding:8px 0;border-bottom:1px solid rgba(255,255,255,.08)';
    if(r.type==='item'){
      row.innerHTML=`<div>${escapeHtml(r.label)}</div><div style="display:flex;gap:6px"><button class="small-btn" data-openitem="${r.id}">Open</button><button class="small-btn" data-delitemrec="${r.id}">‚úï</button></div>`;
    } else {
      row.innerHTML=`<div>${escapeHtml(r.label)}</div><div style="display:flex;gap:6px"><button class="small-btn" data-record="${r.label}">Use</button><button class="small-btn" data-delrecord="${r.label}">‚úï</button></div>`;
    }
    recordsList.appendChild(row);
  });
}
recordsModal.addEventListener('click', async e=>{
  const use=e.target.getAttribute('data-record');
  const del=e.target.getAttribute('data-delrecord');
  const openItem=e.target.getAttribute('data-openitem');
  const delItem=e.target.getAttribute('data-delitemrec');
  if(use){ searchInput.value=use; renderList(); closeModal('recordsModal'); searchInput.focus(); }
  if(del){ state.recentSearches=state.recentSearches.filter(x=>x!==del); await saveRecent(); renderRecords(); }
  if(openItem){ state.ui.activeDropdownItemId=openItem; state.ui.mini = {itemId:openItem, amount:0, gramsInput:'', priceInput:''}; bumpRecentItem(openItem); renderList(); closeModal('recordsModal'); }
  if(delItem){ state.recentItems=state.recentItems.filter(x=>x!==delItem); await saveRecentItems(); renderRecords(); }
});
document.getElementById('clearRecordsBtn').addEventListener('click', async ()=>{ if(state.recentSearches.length||state.recentItems.length){ if(confirm('Clear all recent?')){ state.recentSearches=[]; state.recentItems=[]; await saveRecent(); await saveRecentItems(); renderRecords(); }}});

/* ===== Calculator (main bill) ===== */
function renderCalc(){
  // compute total from lines
  let total = 0;
  calcList.innerHTML='';
  const frag = document.createDocumentFragment();

  state.calc.lines.forEach((ln, idx)=>{
    total += ln.lineTotal; // already rupee-rounded
    const row=document.createElement('div');
    row.className='row'; row.style.cssText='display:flex;align-items:center;justify-content:space-between;border-bottom:1px solid rgba(255,255,255,.08);padding:8px 0;gap:8px';
    const left=`<div style="flex:1;min-width:0">
      <div style="font-weight:600;overflow:hidden;text-overflow:ellipsis;white-space:nowrap">${escapeHtml(ln.itemName)}</div>
      <div class="small-muted">${ln.grams? (ln.grams+'g') : ''} ${ln.grams&&ln.price? '‚Ä¢' : ''} ${ln.price? ('‚Çπ'+ln.price) : ''}</div>
    </div>`;
    const right=`<div style="display:flex;align-items:center;gap:8px">
      <div>${fmtMain(ln.lineTotal)}</div>
      <button class="small-btn" data-del-line="${idx}">‚úï</button>
    </div>`;
    row.innerHTML = left + right;
    frag.appendChild(row);
  });
  state.calc.total = total;
  calcList.appendChild(frag);
  mainTotalTop.innerHTML = fmtMain(total);
  saveCalc();
}
calcList.addEventListener('click', (e)=>{
  const del = e.target.getAttribute('data-del-line');
  if(del!=null){
    state.calc.lines.splice(parseInt(del,10),1);
    renderCalc();
  }
});
clearBillBtn.addEventListener('click', ()=>{
  if(state.calc.lines.length===0) return;
  if(confirm('Clear the current bill?')){
    state.calc.lines = [];
    renderCalc();
  }
});
saveBillBtn.addEventListener('click', ()=>{
  if(state.calc.lines.length===0) { alert('Nothing to save.'); return; }
  const receipt = { id:genId(), ts: Date.now(), lines: JSON.parse(JSON.stringify(state.calc.lines)), total: state.calc.total };
  state.bills.unshift(receipt);
  state.bills = state.bills.slice(0,20);
  saveBills();
  // Clear current bill after save
  state.calc.lines = [];
  renderCalc();
  alert('Saved to Bill history.');
});

/* Bill history UI */
function renderBills(){
  billList.innerHTML='';
  if(!state.bills.length){ billList.innerHTML='<div class="small-muted" style="text-align:center;padding:10px 0">No bills yet</div>'; return; }
  state.bills.forEach((b, i)=>{
    const d=new Date(b.ts);
    const row=document.createElement('div'); row.className='row';
    row.innerHTML = `<div>
        <div style="font-weight:600">${d.toLocaleString()}</div>
        <div class="small-muted">${b.lines.length} items</div>
      </div>
      <div style="display:flex;align-items:center;gap:8px">
        <div>${fmtMain(b.total)}</div>
        <button class="small-btn" data-view-bill="${i}">üëÅÔ∏è</button>
        <button class="small-btn" data-del-bill="${i}">‚úï</button>
      </div>`;
    billList.appendChild(row);
  });
}
billList.addEventListener('click', (e)=>{
  const vi = e.target.getAttribute('data-view-bill');
  const di = e.target.getAttribute('data-del-bill');
  if(vi!=null){
    const b=state.bills[parseInt(vi,10)];
    if(!b) return;
    let text = `Bill @ ${new Date(b.ts).toLocaleString()}\n\n`;
    b.lines.forEach((ln, idx)=>{
      text += `${idx+1}. ${ln.itemName} ‚Äî ${ln.grams? (ln.grams+'g ') : ''}${ln.price? ('‚Çπ'+ln.price+' ') : ''}‚Üí ‚Çπ${ln.lineTotal}\n`;
    });
    text += `\nTotal: ‚Çπ${b.total.toFixed(2)}`;
    alert(text);
  }
  if(di!=null){
    if(confirm('Delete this receipt?')){
      state.bills.splice(parseInt(di,10),1);
      saveBills(); renderBills();
    }
  }
});
billBtn.addEventListener('click', ()=>{ renderBills(); openModal('billModal'); });

/* ===== Mini system helpers (will be used in Part 2) ===== */
function setMini(itemId, {amount, gramsInput, priceInput}={}){
  state.ui.mini.itemId = itemId;
  if(amount!=null) state.ui.mini.amount = Math.max(0, Math.floor(amount)); // mini shows whole rupees
  if(gramsInput!=null) state.ui.mini.gramsInput = gramsInput;
  if(priceInput!=null) state.ui.mini.priceInput = priceInput;
}
function miniAddAmount(v){ setMini(state.ui.mini.itemId, {amount: (state.ui.mini.amount + Math.max(0,Math.floor(v||0))) }); renderList(); }
function miniClear(){ setMini(state.ui.mini.itemId, {amount:0}); renderList(); }

function addMiniToBill(item){
  const amt = Math.floor(state.ui.mini.amount||0);
  if(amt<=0) return;
  if(state.calc.lines.length >= (state.settings.lineCap||50)) { alert('Reached line limit in Settings.'); return; }
  const line = {
    itemName: `${item.name1} / ${item.name2} / ${item.name3}`,
    grams: null, price: amt, lineTotal: rupeeRound(amt)
  };
  state.calc.lines.push(line);
  renderCalc();
}

/* Convert helpers (use item's selling price) */
function gramsToPrice(sp, g){ return sp * (g/1000); }
function priceToGrams(sp, p){ return sp>0 ? (p/sp*1000) : 0; }

/* ===== Long‚Äëpress helper (used in presets) ===== */
function attachLongPress(el,onLong){
  let t=null;
  el.addEventListener('pointerdown', e=>{ if(e.button!==0) return; t=setTimeout(()=>onLong(e),520); });
  ['pointerup','pointerleave','pointercancel'].forEach(ev=> el.addEventListener(ev, ()=>{ if(t){clearTimeout(t); t=null;} }));
  el.addEventListener('contextmenu', e=>{ e.preventDefault(); onLong(e); });
}
/* ===== Render list (contains match, one open dropdown, mini system) ===== */
function renderList(){
  const q=(searchInput.value||'').trim().toLowerCase();
  const items = !q ? state.items : state.items.filter(it => {
    const n1=(it.name1||'').toLowerCase(), n2=(it.name2||'').toLowerCase(), n3=(it.name3||'').toLowerCase();
    return n1.includes(q) || n2.includes(q) || n3.includes(q);
  });

  listEl.innerHTML=''; 
  emptyEl.style.display = items.length? 'none' : (state.items.length? 'none':'block');

  const frag=document.createDocumentFragment();

  items.forEach(it=>{
    const card=document.createElement('div'); 
    card.className='card';

    /* Row 1: names + notes */
    const titleRow=document.createElement('div'); 
    titleRow.className='card-row';
    titleRow.innerHTML = `
      <div class="names">${escapeHtml(it.name1)} <span class="sep">/</span> ${escapeHtml(it.name2)} <span class="sep">/</span> ${escapeHtml(it.name3)}</div>
      <div class="row-icons">
        <button class="small-btn" title="Notes" data-notes="${it.id}">üìù</button>
      </div>`;
    card.appendChild(titleRow);

    /* Row 2: meta (Sell left, Bought right, single pencil) */
    const meta=document.createElement('div'); 
    meta.className='meta';
    meta.innerHTML = `
      <div class="sell">‚Çπ${(+it.sprice||0).toFixed(2)}/kg</div>
      <div class="buy">‚Çπ${(+it.bprice||0).toFixed(2)}/kg</div>
      <div class="one-edit"><button class="small-btn" title="Edit prices & names" data-edit-item="${it.id}">‚úèÔ∏è</button></div>`;
    card.appendChild(meta);

    /* Dropdown block */
    const isActive = state.ui.activeDropdownItemId===it.id;
    if(isActive){
      const dropdown=document.createElement('div'); 
      dropdown.className='dropdown';

      const bar=document.createElement('div'); 
      bar.className='bar';

      /* Toggle group (icons only) */
      const toggle=document.createElement('button'); 
      toggle.className='toggle-type'; 
      toggle.setAttribute('data-toggle-type', it.id);
      toggle.innerHTML = `<span class="only">${state.ui.dropdownType==='weight'?'‚öñÔ∏è':'üí∞'}</span>`;
      bar.appendChild(toggle);

      /* Preset strip */
      const row=document.createElement('div'); 
      row.className='preset-row';

      const type = state.ui.dropdownType;
      const presets = it.presets[type] || [];
      presets.forEach((p,i)=>{
        const btn=document.createElement('button'); 
        btn.className='preset'; 
        btn.type='button';
        btn.setAttribute('data-preset-item',it.id); 
        btn.setAttribute('data-preset-type',type); 
        btn.setAttribute('data-preset-index',String(i));

        let bottom;
        if(type==='weight'){
          const grams = Number(p.val)||0;
          const amount = (typeof p.overridePrice==='number') ? p.overridePrice : gramsToPrice(+it.sprice||0, grams);
          bottom = '‚Çπ'+rupeeRound(amount);
        } else {
          const price = Number(p.val)||0;
          const grams = (typeof p.overrideGrams==='number') ? p.overrideGrams : priceToGrams(+it.sprice||0, price);
          bottom = (Math.round(grams)||0)+'g';
        }

        btn.innerHTML = `
          <div class="top">${escapeHtml(p.label)}</div>
          <div class="bottom">${bottom}</div>
          <button class="edit" data-edit-preset="${it.id}" data-type="${type}" data-index="${i}">‚úèÔ∏è</button>`;

        attachLongPress(btn, async ()=>{
          if(confirm('Delete this preset?')){
            if(type==='weight') it.presets.weight.splice(i,1);
            else it.presets.price.splice(i,1);
            await saveItems(); 
            renderList();
          }
        });

        row.appendChild(btn);
      });
      bar.appendChild(row);

      /* Mini converter + mini total + actions */
      const conv=document.createElement('div'); 
      conv.className='conv';

      const mini = (state.ui.mini.itemId===it.id) 
        ? state.ui.mini 
        : { itemId: it.id, amount: 0, gramsInput: '', priceInput: '' };
      state.ui.mini = { itemId: it.id, amount: mini.amount, gramsInput: mini.gramsInput, priceInput: mini.priceInput };

      conv.innerHTML = `
        <div class="input">
          <label>g</label>
          <input type="number" inputmode="decimal" min="0" step="0.01" data-conv-g="${it.id}" value="${state.ui.mini.gramsInput}">
        </div>
        <div class="input">
          <label>‚Çπ</label>
          <input type="number" inputmode="decimal" min="0" step="0.01" data-conv-p="${it.id}" value="${state.ui.mini.priceInput}">
        </div>

        <div class="mini-total">
          <div class="val" id="mini-${it.id}">${fmtMain(state.ui.mini.amount)}</div>
          <div class="mini-actions">
            <button class="small-btn" title="Add this ‚Çπ to mini" data-mini-rupee="${it.id}">‚Çπ</button>
            <button class="small-btn add ${state.ui.mini.amount>0?'enabled':''}" title="Add to bill" data-mini-add="${it.id}">Ôºã</button>
            <button class="small-btn" title="Clear mini total" data-mini-clear="${it.id}">‚àí</button>
          </div>
        </div>`;
      bar.appendChild(conv);

      /* Close dropdown */
      const close=document.createElement('button');
      close.className='small-btn';
      close.setAttribute('data-close-dropdown', it.id);
      close.textContent='‚úï';
      bar.appendChild(close);

      dropdown.appendChild(bar);
      card.appendChild(dropdown);
    }

    /* Tap card body to toggle dropdown and bump MRU */
    card.addEventListener('click', (e)=>{
      const isAction = e.target.closest('.small-btn') || e.target.closest('.preset') || e.target.closest('.toggle-type') || e.target.closest('.conv');
      if(isAction) return;
      const nowOpen = state.ui.activeDropdownItemId!==it.id;
      state.ui.activeDropdownItemId = nowOpen ? it.id : null;
      if(nowOpen){
        state.ui.mini = { itemId: it.id, amount: 0, gramsInput:'', priceInput:'' };
        bumpRecentItem(it.id);
      }
      renderList();
    });

    frag.appendChild(card);
  });

  listEl.appendChild(frag);
}

/* ===== List interactions (click + input) ===== */
listEl.addEventListener('click', async (e)=>{
  /* Edit item */
  const edit=e.target.getAttribute('data-edit-item'); 
  if(edit){ startEditItem(edit); bumpRecentItem(edit); return; }

  /* Notes */
  const notes=e.target.getAttribute('data-notes'); 
  if(notes){ startEditNotes(notes); bumpRecentItem(notes); return; }

  /* Toggle group (‚öñÔ∏è/üí∞) */
  const toggleFor=e.target.getAttribute('data-toggle-type'); 
  if(toggleFor){ state.ui.dropdownType = state.ui.dropdownType==='weight'?'price':'weight'; renderList(); return; }

  /* Close dropdown */
  const closeId=e.target.getAttribute('data-close-dropdown'); 
  if(closeId){ state.ui.activeDropdownItemId=null; renderList(); return; }

  /* Add preset */
  const addItem=e.target.getAttribute('data-add-preset'); 
  const addType=e.target.getAttribute('data-type'); 
  if(addItem&&addType){ startEditPreset({itemId:addItem,type:addType,presetIndex:-1}); return; }

  /* Edit preset */
  const ep=e.target.getAttribute('data-edit-preset');
  if(ep){ 
    const t=e.target.getAttribute('data-type'); 
    const idx=parseInt(e.target.getAttribute('data-index'),10); 
    startEditPreset({itemId:ep,type:t,presetIndex:idx}); 
    return; 
  }

  /* Preset tap ‚Üí add to mini total */
  const presetBtn = e.target.closest('.preset');
  if(presetBtn && presetBtn.getAttribute('data-preset-item')){
    const pid = presetBtn.getAttribute('data-preset-item');
    const t = presetBtn.getAttribute('data-preset-type');
    const idx = parseInt(presetBtn.getAttribute('data-preset-index'),10);
    const it = byId(pid); if(!it) return;
    const p = it.presets[t][idx];

    let add = 0;
    if(t==='weight'){
      const grams = Number(p.val)||0;
      const amount = (typeof p.overridePrice==='number') ? p.overridePrice : gramsToPrice(+it.sprice||0, grams);
      add = rupeeRound(amount);
    } else {
      const price = Number(p.val)||0;
      add = rupeeRound( (typeof p.overrideGrams==='number') ? ( (+it.sprice||0) * (p.overrideGrams/1000) ) : price );
    }
    state.ui.mini.itemId = it.id;
    miniAddAmount(add);
    bumpRecentItem(it.id);
    return;
  }

  /* Mini: add ‚Çπ from converter field to mini total */
  const addR=e.target.getAttribute('data-mini-rupee');
  if(addR){
    const it = byId(addR); if(!it) return;
    const p = parseFloat(state.ui.mini.priceInput)||0;
    const inc = rupeeRound(p);
    if(inc>0) miniAddAmount(inc);
    return;
  }

  /* Mini: add to bill (‚ÄúÔºã‚Äù) */
  const addMini=e.target.getAttribute('data-mini-add');
  if(addMini){
    const it = byId(addMini); if(!it) return;
    if(state.ui.mini.amount>0){
      addMiniToBill(it);
      bumpRecentItem(it.id);
    }
    return;
  }

  /* Mini: clear (‚Äú‚àí‚Äù) */
  const clr=e.target.getAttribute('data-mini-clear');
  if(clr){ miniClear(); return; }
});

/* Converter inputs */
listEl.addEventListener('input', (e)=>{
  /* grams ‚Üí price */
  const gFor=e.target.getAttribute('data-conv-g');
  if(gFor){
    const it = byId(gFor); if(!it) return;
    const g = parseFloat(e.target.value)||0;
    const sp = +it.sprice||0;
    const price = rupeeRound( sp*(g/1000) );
    const priceInput = listEl.querySelector(`input[data-conv-p="${gFor}"]`);
    if(priceInput) priceInput.value = price>0? String(price) : '';
    setMini(it.id, { amount: price, gramsInput: (g? String(g):''), priceInput: (price? String(price):'') });
    renderList();
    return;
  }
  /* price ‚Üí grams */
  const pFor=e.target.getAttribute('data-conv-p');
  if(pFor){
    const it = byId(pFor); if(!it) return;
    const p = parseFloat(e.target.value)||0;
    const sp = +it.sprice||0;
    const grams = Math.round( sp>0 ? (p/sp*1000) : 0 );
    const gramsInput = listEl.querySelector(`input[data-conv-g="${pFor}"]`);
    if(gramsInput) gramsInput.value = grams>0? String(grams) : '';
    setMini(it.id, { amount: rupeeRound(p), gramsInput: (grams? String(grams):''), priceInput: (p? String(p):'') });
    renderList();
  }
});

/* ===== Service worker register + boot ===== */
if('serviceWorker' in navigator){
  window.addEventListener('load', ()=>{ navigator.serviceWorker.register('./sw.js').catch(()=>{}); });
}

/* Start app */
loadAll();
</script>
</body>
</html>
